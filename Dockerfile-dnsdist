# USAGE

#   docker build --build-arg MAKEFLAGS=-j8 -t dnsdist -f docker/Dockerfile-dnsdist .
#   docker run -p 3053:53 -p 3053:53/udp -p 3199:5199/tcp -p 3083:8083/tcp -ti --rm dnsdist

# CROSS COMPILING:
#   docker build --build-arg MAKEFLAGS=-j8 -t dnsdist -f docker/Dockerfile-dnsdist --platform=linux/arm64/v8 .
#   docker build --build-arg MAKEFLAGS=-j8 -t dnsdist -f docker/Dockerfile-dnsdist --platform=linux/arm/v7 .
#   docker build --build-arg MAKEFLAGS=-j8 -t dnsdist -f docker/Dockerfile-dnsdist --platform=linux/amd64 .
#   docker build --build-arg MAKEFLAGS=-j8 -t dnsdist -f docker/Dockerfile-dnsdist --platform=linux/386 .

ARG DEBIAN_VERSION=11

# Bundles the right cross compiler and other tools as native binaries for this build host.
# It bundles nothing when the build platform is the same as the target platform.
FROM --platform=$BUILDPLATFORM debian:${DEBIAN_VERSION}-slim AS native-tools
RUN apt-get update && apt-get -y dist-upgrade && apt-get clean
ARG TARGETPLATFORM
ARG BUILDPLATFORM
# Use this to disable native tool bundling, e.g. for debugging, or if you like to take it slow.
ARG NO_NATIVE=0
COPY builder-support/cross/bundle-native-tools.sh /bundle-native-tools.sh
RUN /bundle-native-tools.sh


# -------------------------------------------------------------------------
# Builder
# This image uses the target platform. if this differs from the build host platform,
# it requires emulation. Not all architectures are supported for QEMU emulation and
# are more reliable than others. 
# Emulation requires QEMU to be installed on the build host and binfmt misc registrations.
FROM --platform=$TARGETPLATFORM debian:${DEBIAN_VERSION}-slim AS builderbase

# Overwrite the local filesystem with native binaries if we are cross compiling.
COPY --from=native-tools /native.tar /native.tar
RUN tar -C / -xvf /native.tar

ENV NO_LUA_JIT="s390x arm64 mips64el"

# TODO: make sure /source looks roughly the same from git or tar

# Reusable layer for base update
RUN apt-get update && apt-get -y dist-upgrade && apt-get clean

# devscripts gives us mk-build-deps (and a lot of other stuff)
RUN apt-get update && apt-get -y dist-upgrade && apt-get install -y  --no-install-recommends devscripts equivs git && apt-get clean

# We use the dependencies from this control file
# TODO: control file is not in tarballs at all right now
COPY builder-support/debian /source/builder-support/debian

# TODO: control file is not in tarballs at all right now
RUN mk-build-deps -i -t 'apt-get -y -o Debug::pkgProblemResolver=yes --no-install-recommends' /source/builder-support/debian/dnsdist/debian-buster/control && \
    apt-get clean

# Again, because the install overwrote the compiler and other things with target arch binaries
RUN tar -C / -xvf /native.tar

COPY builder-support /source/builder-support
COPY pdns /source/pdns
COPY build-aux /source/build-aux
COPY m4 /source/m4
COPY ext /source/ext
COPY builder/helpers/set-configure-ac-version.sh /usr/local/bin
COPY .git /source/.git

# build and install (TODO: before we hit this line, rearrange /source structure if we are coming from a tarball)
WORKDIR /source/pdns/dnsdistdist

ARG MAKEFLAGS=
ENV MAKEFLAGS ${MAKEFLAGS:--j2}

ARG DOCKER_FAKE_RELEASE=NO
ENV DOCKER_FAKE_RELEASE ${DOCKER_FAKE_RELEASE}

RUN touch dnsdist.1 # avoid having to install pandoc and venv

RUN if [ "${DOCKER_FAKE_RELEASE}" = "YES" ]; then \
      BUILDER_VERSION="$(IS_RELEASE=YES BUILDER_MODULES=dnsdist ./builder-support/gen-version | sed 's/\([0-9]\+\.[0-9]\+\.[0-9]\+\(\(alpha|beta|rc\)\d\+\)\)?.*/\1/')" set-configure-ac-version.sh;\
    fi && \
    BUILDER_MODULES=dnsdist autoreconf -vfi

# -------------------------------------------------------------------------
FROM builderbase as builder

RUN mkdir /build && \
    LUAVER=$([ -z "${NO_LUA_JIT##*$(dpkg --print-architecture)*}" ] && echo 'lua5.3' || echo 'luajit') && \
    . /buildenv.sh && \
    ./configure \
      --with-lua=${LUAVER} \
      LDFLAGS=-rdynamic \
      --sysconfdir=/etc/dnsdist \
      --enable-option-checking=fatal \
      --enable-dnscrypt \
      --enable-dns-over-tls \
      --enable-dns-over-https \
      --with-re2 \
      --host=${DEB_HOST_GNU_TYPE}

RUN make clean && \
    . /buildenv.sh && \
    make $MAKEFLAGS install DESTDIR=/build && make clean && \
    strip /build/usr/local/bin/*

RUN cd /tmp && mkdir /build/tmp/ && mkdir debian && \
    echo 'Source: docker-deps-for-pdns' > debian/control && \
    dpkg-shlibdeps /build/usr/local/bin/dnsdist && \
    sed 's/^shlibs:Depends=/Depends: /' debian/substvars >> debian/control && \
    equivs-build debian/control && \
    dpkg-deb -I equivs-dummy_1.0_all.deb && cp equivs-dummy_1.0_all.deb /build/tmp/

# -------------------------------------------------------------------------
# Runtime
FROM --platform=$TARGETPLATFORM debian:${DEBIAN_VERSION}-slim AS dist

# Reusable layer for base update - Should be cached from builder
RUN apt-get update && apt-get -y dist-upgrade && apt-get clean

# - python3 and jinja2 (for startup script)
# - python3-atomicwrites (for backend management)
# - tini (for signal management)
# - ca-certificates (for verifying downstream DoH/DoT certificates)
RUN apt-get install -y python3 python3-jinja2 python3-atomicwrites tini libcap2-bin ca-certificates && apt-get clean

# Output from builder
COPY --from=builder /build /
RUN chmod 1777 /tmp # FIXME: better not use /build/tmp for equivs at all

# Ensure dependencies are present
RUN apt-get install -y /tmp/equivs-dummy_1.0_all.deb && apt-get clean

# Config
RUN mkdir -p /etc/dnsdist/conf.d /etc/dnsdist/templates.d
COPY dockerdata/dnsdist.conf /etc/dnsdist/

# Start script
COPY dockerdata/startup.py /usr/local/bin/dnsdist-startup

# Work with pdns user - not root
RUN adduser --system --disabled-password --disabled-login --no-create-home --group pdns --uid 953
RUN chown pdns:pdns /etc/dnsdist/conf.d /etc/dnsdist/templates.d
USER pdns

# Default DNS ports
EXPOSE 53/udp
EXPOSE 53/tcp
# Default console port
EXPOSE 5199/tcp
# Default webserver port
EXPOSE 8083/tcp

WORKDIR /etc/dnsdist

COPY dockerdata/dnsdist-resolver.lua /etc/dnsdist/
COPY dockerdata/dnsdist-resolver.py /usr/local/bin/dnsdist-resolver

ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/dnsdist-startup"]
